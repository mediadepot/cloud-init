---
ignition:
  config:
    append:
    - source: https://mediadepot.github.io/ignition/ignition.d/base.json
    - source: https://mediadepot.github.io/ignition/ignition.d/mergerfs.json
    - source: https://mediadepot.github.io/ignition/ignition.d/samba.json
    - source: https://mediadepot.github.io/ignition/ignition.d/portainer.json
    - source: https://mediadepot.github.io/ignition/ignition.d/traefik.json
    - source: https://mediadepot.github.io/ignition/ignition.d/dnsmasq.json
    - source: https://mediadepot.github.io/ignition/ignition.d/notifications.json
    - source: https://mediadepot.github.io/ignition/ignition.d/smartmontools.json
  timeouts: {}
networkd: {}
passwd:
  users:
  - name: core
    ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAIEA0QIsn450XjpKdoAicWqu6pgoc7h+lUokibTF75NcLVhrhnOn8aVpV+MemlE6kt6wjZDK7WyTEX1+/4dIFwH92+TJwBRKG8Yd0aTFHjWZg7K/dZAak041sF21D9K+7R0PtZK/B6szbdN9bZtwss2ebuzMu9Pxw3Rzq/PsPfl9nzs=
  - name: depot
    uid: 15000
    primary_group: depot
    no_user_group: true
    system: false
    ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAIEA0QIsn450XjpKdoAicWqu6pgoc7h+lUokibTF75NcLVhrhnOn8aVpV+MemlE6kt6wjZDK7WyTEX1+/4dIFwH92+TJwBRKG8Yd0aTFHjWZg7K/dZAak041sF21D9K+7R0PtZK/B6szbdN9bZtwss2ebuzMu9Pxw3Rzq/PsPfl9nzs=
    shell: "/bin/bash"
storage:
  directories:
  - filesystem: root
    mode: 493 #755
    path: "/mnt/drive1/"
    user:
      id: 15000
    group:
      id: 15000
  - filesystem: root
    mode: 493 #755
    path: "/mnt/drive2/"
    user:
      id: 15000
    group:
      id: 15000
  files:
  - filesystem: root
    path: "/etc/default/mediadepot/notify.yaml"
    mode: 384 #600
    contents:
      inline: |
        ---
        pushover_user_key: pushover1234

  - filesystem: root
    path: "/etc/systemd/system/media-storage.mount.d/overrides.conf"
    mode: 420 #644
    contents:
      inline: |
        [Unit]
        Requires = mnt-drive1.mount
        Requires = mnt-drive2.mount
        After = mnt-drive1.mount
        After = mnt-drive2.mount
  - filesystem: root
    path: "/opt/mediadepot/smartmontools/smartd.conf"
    mode: 420 #644
    contents:
      inline: |
        # Configuration file for smartd.
        # -a | monitor all SMART properties
        # -o | [ATA only] Enables SMART Automatic Offline Testing when smartd starts up and has no further effect. The valid arguments to this Directive are on and off.
        # -m | Send a warning email to the email address ADD if the '-H', '-l', '-f', '-C', or '-O' Directives detect a failure or a new error, or if a SMART command to the disk fails.
        # -M | modify the behavior of the smartd email warnings enabled with the '-m' email Directive. un the executable PATH instead of the default mail command, when smartd needs to send email. PATH must point to an executable binary file or script.
        # -s | Run Self-Tests or Offline Immediate Tests, at scheduled times. A Self- or Offline Immediate Test will be run at the end of periodic device polling, if all 12 characters of the string T/MM/DD/d/HH match the extended regular expression
        #
        # S/../.././02 | schedule a short Self-Test between 2-3 am every morning
        # L/../../6/03 | schedule a long Self-Test between 3-4 am every Saturday morning
        /dev/sdb -a -o on -S on -s (S/../.././02|L/../../6/03) -m @ALL -M exec /etc/smartd_warning.sh
        /dev/sdc -a -o on -S on -s (S/../.././02|L/../../6/03) -m @ALL -M exec /etc/smartd_warning.sh

systemd:
  units:
  - name: mnt-drive1.mount
    enable: true
    contents: |-
      [Mount]
      What=/dev/sdb
      Where=/mnt/drive1
      Type=ext4

      [Install]
      WantedBy=local-fs.target
  - name: mnt-drive2.mount
    enable: true
    contents: |-
      [Mount]
      What=/dev/sdc
      Where=/mnt/drive2
      Type=ext4

      [Install]
      WantedBy=local-fs.target
